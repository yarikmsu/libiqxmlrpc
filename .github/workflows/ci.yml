name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.runner }}
    container: ${{ matrix.container }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: ubuntu-24.04
            runner: ubuntu-24.04
            container: ""
            install: sudo apt-get update && sudo apt-get install -y libboost-dev libboost-date-time-dev libboost-thread-dev libboost-test-dev libboost-program-options-dev libboost-chrono-dev libxml2-dev libssl-dev
          - name: ubi8
            runner: ubuntu-latest
            container: redhat/ubi8
            install: dnf install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm && dnf install -y gcc-c++ cmake make boost169-devel libxml2-devel openssl-devel python3 && ln -s /usr/include/boost169/boost /usr/include/boost && ln -s /usr/lib64/boost169/* /usr/lib64/
          - name: macos
            runner: macos-latest
            container: ""
            install: brew install boost libxml2 openssl

    steps:
    - name: Install dependencies
      run: ${{ matrix.install }}

    - name: Checkout
      uses: actions/checkout@v6.0.2

    - name: Configure
      run: |
        mkdir build && cd build
        CMAKE_EXTRA_ARGS=""
        if [ "$(uname)" = "Darwin" ]; then
          CMAKE_EXTRA_ARGS="-DBOOST_ROOT=$(brew --prefix boost)"
        fi
        cmake -Dbuild_tests=ON -DCMAKE_CXX_FLAGS="-DBOOST_TIMER_ENABLE_DEPRECATED -Wall -Wextra -Weffc++ -Werror" $CMAKE_EXTRA_ARGS ..

    - name: Build
      run: cmake --build build

    - name: Test
      run: ctest --test-dir build --output-on-failure

    - name: Interop Test
      run: |
        cd build
        make interop-test

  sanitizers:
    name: ASan/UBSan
    runs-on: ubuntu-24.04
    steps:
    - name: Checkout
      uses: actions/checkout@v6.0.2

    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get install -y clang libboost-dev libboost-date-time-dev libboost-thread-dev libboost-test-dev libboost-program-options-dev libboost-chrono-dev libxml2-dev libssl-dev

    - name: Configure
      run: |
        mkdir build && cd build
        cmake -Dbuild_tests=ON \
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DCMAKE_CXX_FLAGS="-DBOOST_TIMER_ENABLE_DEPRECATED -fsanitize=address,undefined -fno-omit-frame-pointer" \
          -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address,undefined" \
          -DCMAKE_SHARED_LINKER_FLAGS="-fsanitize=address,undefined" \
          ..

    - name: Build
      run: cmake --build build

    - name: Test
      run: ctest --test-dir build --output-on-failure
      env:
        ASAN_OPTIONS: detect_leaks=1:abort_on_error=1
        UBSAN_OPTIONS: print_stacktrace=1:abort_on_error=1

    - name: Interop Test
      run: |
        cd build
        make interop-test
      env:
        ASAN_OPTIONS: detect_leaks=1:abort_on_error=1
        UBSAN_OPTIONS: print_stacktrace=1:abort_on_error=1

  coverage:
    name: coverage
    runs-on: ubuntu-24.04
    steps:
    - name: Checkout
      uses: actions/checkout@v6.0.2

    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get install -y libboost-dev libboost-date-time-dev libboost-thread-dev libboost-test-dev libboost-program-options-dev libboost-chrono-dev libxml2-dev libssl-dev lcov

    - name: Configure
      run: |
        mkdir build && cd build
        cmake -Dbuild_tests=ON \
          -DCMAKE_C_FLAGS="--coverage" \
          -DCMAKE_CXX_FLAGS="-DBOOST_TIMER_ENABLE_DEPRECATED --coverage" \
          -DCMAKE_EXE_LINKER_FLAGS="--coverage" \
          -DCMAKE_SHARED_LINKER_FLAGS="--coverage" \
          ..

    - name: Build
      run: cmake --build build

    - name: Test
      run: ctest --test-dir build --output-on-failure --output-junit junit.xml

    - name: Interop Test
      run: |
        cd build
        make interop-test

    - name: Upload test results to Codecov
      if: ${{ !cancelled() }}
      uses: codecov/test-results-action@v1
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: build/junit.xml
        flags: unittests
        verbose: true

    - name: Generate coverage report
      run: |
        echo "=== Capturing coverage ==="
        lcov --capture --directory . --output-file coverage.info --ignore-errors empty,gcov,mismatch,negative --rc branch_coverage=1
        lcov --remove coverage.info '/usr/*' '*/tests/*' '*/boost/*' --output-file coverage.info --ignore-errors empty,unused,mismatch,negative --rc branch_coverage=1
        echo ""
        echo "=== Coverage Summary ==="
        lcov --summary coverage.info --ignore-errors empty --rc branch_coverage=1
        echo ""
        echo "=== Per-file coverage (from gcov) ==="
        gcov -b -n build/libiqxmlrpc/CMakeFiles/iqxmlrpc.dir/*.gcda 2>/dev/null | grep -E "^File|^Lines|^Branches" | head -100 || true

    - name: Upload to Codecov
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: coverage.info
        fail_ci_if_error: true
        verbose: true

  tsan:
    name: TSan
    runs-on: ubuntu-24.04
    steps:
    - name: Checkout
      uses: actions/checkout@v6.0.2

    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get install -y clang libboost-dev libboost-date-time-dev libboost-thread-dev libboost-test-dev libboost-program-options-dev libboost-chrono-dev libxml2-dev libssl-dev

    - name: Configure
      run: |
        mkdir build && cd build
        cmake -Dbuild_tests=ON \
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DCMAKE_CXX_FLAGS="-DBOOST_TIMER_ENABLE_DEPRECATED -fsanitize=thread -fno-omit-frame-pointer -g" \
          -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=thread" \
          -DCMAKE_SHARED_LINKER_FLAGS="-fsanitize=thread" \
          ..

    - name: Build
      run: cmake --build build

    - name: Test
      run: |
        # Exclude lockfree_stress tests - they stress-test Boost.Lockfree which
        # produces TSan false positives. These tests validate correctness via
        # data integrity checks, not TSan cleanliness.
        ctest --test-dir build -LE lockfree_stress --output-on-failure
      env:
        TSAN_OPTIONS: halt_on_error=1:second_deadlock_stack=1:history_size=4:suppressions=${{ github.workspace }}/tests/tsan.suppressions

    - name: Interop Test
      run: |
        cd build
        make interop-test
      env:
        TSAN_OPTIONS: halt_on_error=1:second_deadlock_stack=1:history_size=4:suppressions=${{ github.workspace }}/tests/tsan.suppressions

  fuzz:
    name: Fuzz Testing
    runs-on: ubuntu-24.04
    steps:
    - name: Checkout
      uses: actions/checkout@v6.0.2

    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get install -y clang libboost-dev libboost-date-time-dev libboost-thread-dev libxml2-dev libssl-dev

    - name: Configure
      run: |
        mkdir build && cd build
        cmake \
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DCMAKE_CXX_FLAGS="-DBOOST_TIMER_ENABLE_DEPRECATED -fsanitize=fuzzer-no-link,address,undefined -fno-omit-frame-pointer" \
          -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address,undefined" \
          -DCMAKE_SHARED_LINKER_FLAGS="-fsanitize=address,undefined" \
          -DLIB_FUZZING_ENGINE="-fsanitize=fuzzer" \
          -Dbuild_fuzzers=ON \
          -Dbuild_tests=OFF \
          ..

    - name: Build
      run: cmake --build build

    - name: Create corpus directories
      run: |
        mkdir -p corpus/request corpus/response corpus/http corpus/value
        # Seed corpus for request fuzzer
        echo '<?xml version="1.0"?><methodCall><methodName>test</methodName></methodCall>' > corpus/request/seed1.xml
        echo '<?xml version="1.0"?><methodCall><methodName>sum</methodName><params><param><value><i4>1</i4></value></param></params></methodCall>' > corpus/request/seed2.xml
        # Seed corpus for response fuzzer
        echo '<?xml version="1.0"?><methodResponse><params><param><value><string>OK</string></value></param></params></methodResponse>' > corpus/response/seed1.xml
        echo '<?xml version="1.0"?><methodResponse><fault><value><struct><member><name>faultCode</name><value><int>1</int></value></member></struct></value></fault></methodResponse>' > corpus/response/seed2.xml
        # Seed corpus for HTTP fuzzer
        printf 'POST /RPC2 HTTP/1.1\r\nHost: localhost\r\nContent-Length: 100\r\n\r\n' > corpus/http/seed1.txt
        printf 'HTTP/1.1 200 OK\r\nContent-Type: text/xml\r\nContent-Length: 50\r\n\r\n' > corpus/http/seed2.txt
        # Seed corpus for value fuzzer (raw value content)
        echo '<i4>42</i4>' > corpus/value/seed1.xml
        echo '<array><data><value><string>test</string></value></data></array>' > corpus/value/seed2.xml
        echo '<struct><member><name>key</name><value><boolean>1</boolean></value></member></struct>' > corpus/value/seed3.xml

    - name: Run fuzzers
      run: |
        cd build/fuzz
        echo "=== Running fuzz_request (45s) ==="
        timeout 45 ./fuzz_request -dict=../../fuzz/xml.dict ../../corpus/request/ 2>&1 || true
        echo ""
        echo "=== Running fuzz_response (45s) ==="
        timeout 45 ./fuzz_response -dict=../../fuzz/xml.dict ../../corpus/response/ 2>&1 || true
        echo ""
        echo "=== Running fuzz_http (45s) ==="
        timeout 45 ./fuzz_http -dict=../../fuzz/http.dict ../../corpus/http/ 2>&1 || true
        echo ""
        echo "=== Running fuzz_value (45s) ==="
        timeout 45 ./fuzz_value -dict=../../fuzz/xml.dict ../../corpus/value/ 2>&1 || true
      env:
        ASAN_OPTIONS: detect_leaks=1:abort_on_error=1
        UBSAN_OPTIONS: print_stacktrace=1:abort_on_error=1

    - name: Check for crashes
      run: |
        if ls build/fuzz/crash-* 2>/dev/null || ls build/fuzz/oom-* 2>/dev/null; then
          echo "::error::Fuzzer found crashes!"
          exit 1
        fi
        echo "No crashes found"

    - name: Upload crash artifacts
      uses: actions/upload-artifact@v6
      if: failure()
      with:
        name: fuzzer-crashes
        path: |
          build/fuzz/crash-*
          build/fuzz/oom-*
        if-no-files-found: ignore

  cppcheck:
    name: cppcheck
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v6.0.2

    - name: Install cppcheck
      run: sudo apt-get update && sudo apt-get install -y cppcheck

    - name: Run cppcheck
      run: |
        cppcheck --enable=warning,style,performance,portability \
          --suppress=missingIncludeSystem \
          --inline-suppr \
          --error-exitcode=1 \
          libiqxmlrpc/

  clang-tidy:
    name: clang-tidy
    runs-on: ubuntu-24.04
    steps:
    - name: Checkout
      uses: actions/checkout@v6.0.2

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang clang-tidy libboost-dev libboost-date-time-dev \
          libboost-thread-dev libboost-test-dev libboost-program-options-dev \
          libboost-chrono-dev libxml2-dev libssl-dev

    - name: Generate compile_commands.json
      run: |
        mkdir build && cd build
        cmake -Dbuild_tests=ON \
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
          -DCMAKE_CXX_FLAGS="-DBOOST_TIMER_ENABLE_DEPRECATED" \
          ..

    - name: Run clang-tidy
      run: |
        set -euo pipefail
        # Run clang-tidy on library sources only (not tests or fuzz targets)
        # Use -print0/-0 to handle filenames with spaces safely
        find libiqxmlrpc -name '*.cc' -print0 | \
          xargs -0 clang-tidy -p build --warnings-as-errors='*' 2>&1 | tee clang-tidy-output.txt

    - name: Upload clang-tidy output
      uses: actions/upload-artifact@v6
      if: always()
      with:
        name: clang-tidy-output
        path: clang-tidy-output.txt
        if-no-files-found: ignore

  valgrind:
    name: Valgrind
    runs-on: ubuntu-24.04
    steps:
    - name: Checkout
      uses: actions/checkout@v6.0.2

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y valgrind libboost-dev libboost-date-time-dev \
          libboost-thread-dev libboost-test-dev libboost-program-options-dev \
          libboost-chrono-dev libxml2-dev libssl-dev

    - name: Configure
      run: |
        mkdir build && cd build
        cmake -Dbuild_tests=ON \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_FLAGS="-DBOOST_TIMER_ENABLE_DEPRECATED -g -O1" \
          ..

    - name: Build
      run: cmake --build build

    - name: Run Valgrind on unit tests
      run: |
        cd build/tests
        # Run each unit test under Valgrind with uninitialized memory tracking
        # Using --error-exitcode=1 to fail on any Valgrind errors
        # Using -O1 optimization to reduce false positives while keeping debug info
        # Unit tests that don't require network I/O
        # Excluded: integration-test, client-test, server-test, client-stress-test,
        #           socket-test, wire-compatibility-test (require running server)
        #           thread-safety-test (covered by TSan), performance-test (benchmarks)
        for test in value-types-extended-test value-test parser-test http-test \
                    request-response-test method-dispatch-test xheaders-test \
                    exceptions-test safe-math-test perf-utils-test inet-addr-test; do
          echo "=== Running Valgrind on $test ==="
          valgrind --track-origins=yes \
                   --leak-check=full \
                   --show-leak-kinds=definite,possible \
                   --errors-for-leak-kinds=definite \
                   --error-exitcode=1 \
                   ./$test 2>&1 | tee valgrind-$test.log
        done

    - name: Upload Valgrind logs
      uses: actions/upload-artifact@v6
      if: always()
      with:
        name: valgrind-logs
        path: build/tests/valgrind-*.log
        if-no-files-found: ignore
