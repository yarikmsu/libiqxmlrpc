name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.runner }}
    container: ${{ matrix.container }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: ubuntu-24.04
            runner: ubuntu-24.04
            container: ""
            install: sudo apt-get update && sudo apt-get install -y libboost-dev libboost-date-time-dev libboost-thread-dev libboost-test-dev libboost-program-options-dev libboost-chrono-dev libxml2-dev libssl-dev
          - name: ubi8
            runner: ubuntu-latest
            container: redhat/ubi8
            install: dnf install -y https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm && dnf install -y gcc-c++ cmake make boost169-devel libxml2-devel openssl-devel && ln -s /usr/include/boost169/boost /usr/include/boost && ln -s /usr/lib64/boost169/* /usr/lib64/
          - name: macos
            runner: macos-latest
            container: ""
            install: brew install boost libxml2 openssl

    steps:
    - name: Install dependencies
      run: ${{ matrix.install }}

    - name: Checkout
      uses: actions/checkout@v4

    - name: Configure
      run: |
        mkdir build && cd build
        cmake -Dbuild_tests=ON -DCMAKE_CXX_FLAGS="-DBOOST_TIMER_ENABLE_DEPRECATED -Wall -Wextra -Weffc++ -Werror" ..

    - name: Build
      run: cmake --build build

    - name: Test
      run: ctest --test-dir build --output-on-failure

  sanitizers:
    name: ASan/UBSan
    runs-on: ubuntu-24.04
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get install -y clang libboost-dev libboost-date-time-dev libboost-thread-dev libboost-test-dev libboost-program-options-dev libboost-chrono-dev libxml2-dev libssl-dev

    - name: Configure
      run: |
        mkdir build && cd build
        cmake -Dbuild_tests=ON \
          -DCMAKE_C_COMPILER=clang \
          -DCMAKE_CXX_COMPILER=clang++ \
          -DCMAKE_CXX_FLAGS="-DBOOST_TIMER_ENABLE_DEPRECATED -fsanitize=address,undefined -fno-omit-frame-pointer" \
          -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address,undefined" \
          -DCMAKE_SHARED_LINKER_FLAGS="-fsanitize=address,undefined" \
          ..

    - name: Build
      run: cmake --build build

    - name: Test
      run: ctest --test-dir build --output-on-failure
      env:
        ASAN_OPTIONS: detect_leaks=1:abort_on_error=1
        UBSAN_OPTIONS: print_stacktrace=1:abort_on_error=1

  coverage:
    name: coverage
    runs-on: ubuntu-24.04
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install dependencies
      run: sudo apt-get update && sudo apt-get install -y libboost-dev libboost-date-time-dev libboost-thread-dev libboost-test-dev libboost-program-options-dev libboost-chrono-dev libxml2-dev libssl-dev lcov

    - name: Configure
      run: |
        mkdir build && cd build
        cmake -Dbuild_tests=ON \
          -DCMAKE_C_FLAGS="--coverage" \
          -DCMAKE_CXX_FLAGS="-DBOOST_TIMER_ENABLE_DEPRECATED --coverage" \
          -DCMAKE_EXE_LINKER_FLAGS="--coverage" \
          -DCMAKE_SHARED_LINKER_FLAGS="--coverage" \
          ..

    - name: Build
      run: cmake --build build

    - name: Test
      run: ctest --test-dir build --output-on-failure --output-junit junit.xml

    - name: Upload test results to Codecov
      if: ${{ !cancelled() }}
      uses: codecov/test-results-action@v1
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: build/junit.xml
        flags: unittests
        verbose: true

    - name: Generate coverage report
      run: |
        echo "=== Capturing coverage ==="
        lcov --capture --directory . --output-file coverage.info --ignore-errors empty,gcov,mismatch,negative --rc branch_coverage=1
        lcov --remove coverage.info '/usr/*' '*/tests/*' '*/boost/*' --output-file coverage.info --ignore-errors empty,unused,mismatch,negative --rc branch_coverage=1
        echo ""
        echo "=== Coverage Summary ==="
        lcov --summary coverage.info --ignore-errors empty --rc branch_coverage=1
        echo ""
        echo "=== Per-file coverage (from gcov) ==="
        gcov -b -n build/libiqxmlrpc/CMakeFiles/iqxmlrpc.dir/*.gcda 2>/dev/null | grep -E "^File|^Lines|^Branches" | head -100 || true

    - name: Upload to Codecov
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: coverage.info
        fail_ci_if_error: true
        verbose: true

  cppcheck:
    name: cppcheck
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install cppcheck
      run: sudo apt-get update && sudo apt-get install -y cppcheck

    - name: Run cppcheck
      run: |
        cppcheck --enable=warning,style,performance,portability \
          --suppress=missingIncludeSystem \
          --inline-suppr \
          --error-exitcode=1 \
          libiqxmlrpc/
