# Coverity Scan - Deep Static Analysis
# Free for open source projects at https://scan.coverity.com
#
# Setup required by project owner:
# 1. Register project at https://scan.coverity.com/projects/new
# 2. Add COVERITY_SCAN_TOKEN secret to GitHub repository settings
# 3. Add COVERITY_SCAN_EMAIL secret (email used for Coverity registration)
#
# Coverity has submission limits for free projects, so this runs:
# - Weekly on schedule
# - On manual trigger (workflow_dispatch)
# - On pushes to master (limited to avoid hitting quota)

name: Coverity Scan

on:
  schedule:
    # Run weekly on Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:
    # Allow manual trigger
  push:
    branches: [master]
    paths:
      # Only run on changes to library source code
      - 'libiqxmlrpc/**'

env:
  COVERITY_PROJECT: yarikmsu%2Flibiqxmlrpc

jobs:
  coverity:
    name: Coverity Scan
    runs-on: ubuntu-24.04
    # Don't run on forks (they won't have the secrets)
    if: github.repository == 'yarikmsu/libiqxmlrpc'
    permissions:
      contents: read

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        set -euo pipefail
        sudo apt-get update
        sudo apt-get install -y libboost-dev libboost-date-time-dev \
          libboost-thread-dev libboost-test-dev libboost-program-options-dev \
          libboost-chrono-dev libxml2-dev libssl-dev curl

    - name: Download Coverity Build Tool
      run: |
        set -euo pipefail
        curl --max-time 300 --connect-timeout 30 -fsSL \
          https://scan.coverity.com/download/linux64 \
          --data "token=${COV_TOKEN}&project=${COVERITY_PROJECT}" \
          -o coverity_tool.tgz
        # Verify download succeeded
        if [[ ! -s coverity_tool.tgz ]]; then
          echo "::error::Failed to download Coverity tool"
          exit 1
        fi
        mkdir -p coverity_tool
        tar xzf coverity_tool.tgz --strip-components=1 -C coverity_tool || {
          echo "::error::Failed to extract Coverity tool"
          exit 1
        }
        # Verify extraction succeeded
        if [[ ! -x coverity_tool/bin/cov-build ]]; then
          echo "::error::Coverity tool extraction incomplete - cov-build not found"
          exit 1
        fi
      env:
        COV_TOKEN: ${{ secrets.COVERITY_SCAN_TOKEN }}

    - name: Configure
      run: |
        set -euo pipefail
        mkdir build && cd build
        cmake -Dbuild_tests=ON \
          -DCMAKE_CXX_FLAGS="-DBOOST_TIMER_ENABLE_DEPRECATED -Wall -Wextra" \
          ..

    - name: Build with Coverity
      run: |
        set -euo pipefail
        export PATH="$(pwd)/coverity_tool/bin:$PATH"
        cd build
        cov-build --dir cov-int make -j$(nproc)
        # Verify build capture succeeded
        if [[ ! -f cov-int/build-log.txt ]]; then
          echo "::error::Coverity build capture failed - no build log"
          exit 1
        fi
        echo "Build capture complete. Files captured:"
        wc -l cov-int/build-log.txt

    - name: Submit to Coverity Scan
      run: |
        set -euo pipefail
        cd build
        tar czvf libiqxmlrpc-cov.tgz cov-int
        # Submit with timeout and capture HTTP status
        http_code=$(curl --max-time 600 --connect-timeout 30 -sSL \
          --form "token=${COV_TOKEN}" \
          --form "email=${COV_EMAIL}" \
          --form file=@libiqxmlrpc-cov.tgz \
          --form version="$(git rev-parse --short HEAD)" \
          --form description="Automated Coverity Scan from GitHub Actions" \
          -w "%{http_code}" \
          -o response.txt \
          "https://scan.coverity.com/builds?project=${COVERITY_PROJECT}")
        # Check HTTP status code
        if [[ "$http_code" -lt 200 || "$http_code" -ge 300 ]]; then
          echo "::error::Coverity submission failed with HTTP $http_code"
          exit 1
        fi
        # Check response for error indicators (sanitized output - no raw response)
        if grep -qiE "error|failed|exceeded|denied|quota" response.txt; then
          echo "::error::Coverity submission issue detected in response"
          # Show only safe portions of response (filter out potential secrets)
          grep -viE "token|key|secret|password|credential" response.txt || true
          exit 1
        fi
        echo "Submission successful (HTTP $http_code)"
      env:
        COV_TOKEN: ${{ secrets.COVERITY_SCAN_TOKEN }}
        COV_EMAIL: ${{ secrets.COVERITY_SCAN_EMAIL }}

    - name: Cleanup
      if: always()
      run: |
        rm -rf coverity_tool coverity_tool.tgz response.txt
        rm -rf build/cov-int build/libiqxmlrpc-cov.tgz
